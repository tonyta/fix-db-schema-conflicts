#!/usr/bin/env ruby
#
# usage: bin/generate-schema-examples
#
# Generates the original and expected schemas for each test app:
#   - db/schema.original.rb → original schema generated by Rails
#   - db/schema.expected.rb → expected schema after fix-db-schema-conflicts
#
require 'pathname'
require 'fileutils'

test_app_dirs = Pathname.glob(Pathname.new(__dir__).join('../rails-*-app/'))

test_app_dirs.each do |app_root|
  FileUtils.cd(app_root, verbose: true) do
    envs = {
      fixed:              {},
      only_sorted:        { "DISABLE_SCHEMA_AUTOCORRECT" => "true" },
      only_autocorrected: { "DISABLE_SCHEMA_SORT"        => "true" },
      original:           { "DISABLE_SCHEMA_FIX"         => "true" },
    }

    FileUtils.rm_f(app_root.join('Gemfile.lock'))
    Kernel.system("bundle install")

    envs.each do |name, env|
      Kernel.system(env, "bundle exec rake db:schema:dump")
      FileUtils.cp(app_root.join('db/schema.rb'), app_root.join("db/schema.#{name}.rb"))
    end
  end
end
